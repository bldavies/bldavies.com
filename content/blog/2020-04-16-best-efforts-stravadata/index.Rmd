---
title: Best efforts in stravadata
tags: [sports]
loadMathJax: no
---

```{r echo = F}
knitr::opts_chunk$set(message = F, warning = F)
```

[stravadata](https://github.com/bldavies/stravadata) now provides data on "best efforts"---fastest times over a range of benchmark distances within each Strava activity---via `best_efforts`:

```{r}
library(dplyr)
library(stravadata)

head(best_efforts)
```

The `id` column stores activity IDs and the `effort` column stores effort descriptions.
The `start_index` and `end_index` columns store each effort's start and end indices in the corresponding activity's [stream](/blog/activity-streams-stravadata).
These indices can be used to compute the distance travelled, time elapsed, and mean pace achieved during each effort:

```{r}
best_effort_paces <- streams %>%
  left_join(best_efforts) %>%
  group_by(id, effort) %>%
  mutate(index = row_number()) %>%
  filter(index == start_index | index == end_index) %>%
  summarise(distance = max(distance) - min(distance),
            time = max(time) - min(time)) %>%
  ungroup() %>%
  mutate(mean_pace = (time / 60) / (distance / 1e3))

head(best_effort_paces)
```

The values in the `distance` column of `best_effort_paces` differ slightly from the distances described in its `effort` column because there is not always a sequence of consecutive stream observations that cover such distances exactly.
However, I expect that, on average, the multiplicative error in `distance` equals the multiplicative error in `time`, so that the `mean_pace` column provides unbiased estimates of my true mean paces.
The chart below uses these estimates to track my personal record 5k, 10k, and half-marathon mean paces since joining Strava in late 2017.

```{r records, echo = F, fig.width = 6, fig.height = 4, dpi = 100, fig.ext = 'svg', dev = 'svg'}
library(ggplot2)
library(tidyr)

theme_set(
  theme_minimal() +
    theme(panel.grid.minor = element_blank(),
          plot.title = element_text(face = 'bold'),
          strip.text = element_text(face = 'bold', hjust = 0, margin = margin(b = 5), size = 10))
)

dec2ms <- function(x) sprintf('%d:%.2d', floor(x), round(60 * x %% 1))

personal_records <- activities %>%
  filter(type == 'Run') %>%
  mutate(date = as.Date(start_time)) %>%
  select(id, date) %>%
  left_join(best_effort_paces) %>%
  group_by(date, effort) %>%
  summarise(mean_pace = min(mean_pace)) %>%
  group_by(effort) %>%
  arrange(date) %>%
  mutate(mean_pace = cummin(mean_pace)) %>%
  filter(row_number() == 1 | mean_pace < lag(mean_pace)) %>%
  ungroup()

efforts <- c('5k', '10k', 'Half-Marathon')
personal_records %>%
  filter(effort %in% efforts) %>%
  full_join(
    crossing(
      effort = unique(.$effort),
      date = seq(min(.$date), Sys.Date(), 'days')
    )
  ) %>%
  group_by(effort) %>%
  arrange(date) %>%
  fill(mean_pace) %>%
  drop_na() %>%
  filter(mean_pace != lag(mean_pace) | mean_pace != lead(mean_pace) | row_number() %in% c(1, n())) %>%
  ungroup() %>%
  ggplot(aes(date, mean_pace, col = factor(effort, levels = efforts))) +
  geom_line() +
  coord_cartesian(clip = 'off') +
  labs(x = 'Date',
       y = 'Mean pace (min/km)',
       title = 'Personal running records since joining Strava',
       subtitle = 'Based on my Strava activity best efforts',
       col = 'Distance') +
  scale_x_date(expand = c(0, 0), date_labels = '%F') +
  scale_y_continuous(expand = c(0, 0), breaks = 4 + 0.25 * (0:8), labels = dec2ms, limits = c(4, NA)) +
  theme(legend.justification = c(0, 0),
        legend.position = c(0, 0))
```

```{r echo = F}
x <- round(60 * filter(personal_records, effort == 'Half-Marathon')$mean_pace)
```

I improved my 5k and 10k personal records significantly while training for, and competing in, the [Wellington Waterfront 5k series](https://waterfront5k.nz) during the 2018/19 and 2019/20 summers.
My mean pace during [Round the Bays](https://wellingtonroundthebays.co.nz) in February 2020 improved on my previous half-marathon record by `r x[1] - x[2]` seconds per kilometre, but the fastest of the half-marathons I have run since improved on my Round the Bays pace by one second per kilometre only.

```{r session-info, echo = F}
bldr::save_session_info()
```
