---
title: Comparing my running patterns during 2018 and 2019
tags: [packages, running, Strava]
---

```{r setup, echo = F, message = F, warning = F}
library(dplyr)
library(ggplot2)
library(knitr)
library(lubridate)
library(purrr)
library(readr)
library(stravadata)
library(tidyr)

opts_chunk$set(echo = F, message = F, warning = F,
               dev = 'svg', fig.ext = 'svg',
               fig.width = 6, fig.height = 4, dpi = 100)

theme_set(
  theme_minimal() +
    theme(panel.grid.minor = element_blank(),
          plot.title = element_text(face = 'bold'),
          strip.text = element_text(face = 'bold', hjust = 0, size = 10))
)

data <- activities %>%
  mutate(date = floor_date(start_time, 'days'),
         year = year(date)) %>%
  filter(year %in% c(2018, 2019) & type == 'Run')
```

This week I created an R package [stravadata](https://github.com/bldavies/stravadata/) that provides convenient access to my [Strava](https://www.strava.com/) activity data.
These data document my running patterns since the start of 2018.

```{r}
table_data <- data %>%
  mutate(distance = distance / 1e3,
         elev_gain = elev_gain / 1e3,
         time_total = time_total / 3600) %>%
  select(year,
         `Total distance (km)` = distance,
         `Total time (hours)` = time_total,
         `Total elevation gain (km)` = elev_gain) %>%
  gather(key, value, -year) %>%
  count(year, key, wt = value) %>%
  spread(year, n) %>%
  slice(c(1, 3, 2))
```

The table below aggregates my total distance, time, and elevation gain across my runs in each of the past two years.
I ran almost twice as far in 2019 as in 2018, but with only a `r round(100 * (table_data[2, 3] / table_data[2, 2] - 1))`% increase in total time and `r round(100 * (table_data[3, 3] / table_data[3, 2] - 1))`% increase in total elevation gain.

```{r}
kable(table_data, digits = 2, col.names = c('', '2018', '2019'), align = 'lrr')
```

I ran on `r n_distinct(filter(data, year == 2018)$date)` distinct days in 2018 and `r n_distinct(filter(data, year == 2019)$date)` distinct days in 2019.
The chart below shows the distribution of these days within each year, with tiles shaded in proportion to the distance run on each day.
The dark tile on the 10th Saturday of 2019 represents me [completing my goal](/blog/goals-2019-update/) to run a half marathon.
I didn't run often during the winter of 2018 or at all while I was in the USA in October 2019.

```{r calendar}
data %>%
  count(year, date, wt = distance) %>%
  mutate(week = floor_date(date, 'weeks', week_start = 1),
         weekday = wday(date, label = T, week_start = 1)) %>%
  group_by(year) %>%
  mutate(week = 1 + floor((week - min(week)) / (60 * 60 * 24 * 7))) %>%
  ggplot(aes(week, weekday)) +
  geom_tile(aes(alpha = n, fill = factor(year)), show.legend = F) +
  coord_cartesian(clip = 'off') +
  facet_wrap(~year, nrow = 2) +
  labs(x = 'Week of year',
       y = NULL,
       title = 'Running days during 2018 and 2019',
       subtitle = 'Darker tiles represent days with longer runs') +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme(panel.grid = element_blank())
```

My Strava activity data describe several "features" for each run, such as my mean pace and heart rate.
Most of these features are estimates by sensors contained within my Garmin running watch.[^most]
The chart below presents the distributions of several features for my runs during 2018 and 2019.
In both years I ran mostly five or 10 kilometres at a time, with proportionally more short runs in 2019.

[^most]: I started using the watch in February 2018. Features for earlier runs are estimates by sensors contained within my iPhone.

```{r features}
feature_data <- data %>%
  mutate(distance = distance / 1e3,
         time_total = time_total / 60,
         mean_pace = (time_moving / 60) / distance) %>%
  select(id,
         year,
         `Distance (km)` = distance,
         `Duration (min)` = time_total,
         `Elevation gain (m)` = elev_gain,
         `Mean pace (min/km)` = mean_pace,
         `Mean HR (beats/min)` = mean_hr,
         `Mean cadence (rot./min)` = mean_cadence)

feature_data %>%
  gather(key, value, -year, -id) %>%
  filter(!is.na(value)) %>%  # Biometric data missing prior to Garmin purchase
  ggplot(aes(value)) +
  geom_density(aes(fill = factor(year)), alpha = 0.5) +
  coord_cartesian(clip = 'off') +
  facet_wrap(~key, scales = 'free') +
  guides(fill = guide_legend(label.position = 'left', title.hjust = 1)) +
  labs(x = NULL,
       y = 'Probability density',
       fill = 'Year',
       title = 'Distributions of run features during 2018 and 2019',
       subtitle = 'Based (mostly) on estimates by my Garmin running watch') +
  scale_x_continuous(expand = c(0, 0)) +
  theme(axis.text.y = element_blank(),
        legend.justification = c(1, 1),
        legend.position = c(1, 1),
        panel.grid.major.y = element_blank())
```

On average, I took faster steps, maintained lower heart rates, and ran at faster paces in 2019 than in 2018.
These differences could be due to increased fitness or to running proportionally fewer hills.
One way to separate these two effects is to compare annual feature distributions after removing the variation in features' values that is explained by variation in elevation gain.
I present this comparison in the chart below.
The mean cadence and heart rate distributions look similar to before controlling for elevation gain, but the improvement in my mean paces is more pronounced.

```{r features-adjusted, fig.height = 2.5}
feature_data %>%
  select(-`Distance (km)`, -`Duration (min)`) %>%
  gather(key, value, `Mean pace (min/km)`, `Mean HR (beats/min)`, `Mean cadence (rot./min)`) %>%
  group_by(year, key) %>%
  filter(!is.na(value)) %>%
  mutate(resid = resid(lm(value ~ -1 + scale(`Elevation gain (m)`)))) %>%
  ggplot(aes(resid)) +
  geom_density(aes(fill = factor(year)), alpha = 0.5) +
  coord_cartesian(clip = 'off') +
  facet_wrap(~key, scales = 'free') +
  guides(fill = guide_legend(label.position = 'left', title.hjust = 1)) +
  labs(x = NULL,
       y = 'Probability density',
       fill = 'Year',
       title = 'Distributions of run features during 2018 and 2019\nafter controlling for elevation gain',
       subtitle = 'Based (mostly) on estimates by my Garmin running watch') +
  scale_x_continuous(expand = c(0, 0)) +
  theme(axis.text.y = element_blank(),
        legend.justification = c(1, 1),
        legend.position = c(1, 1),
        panel.grid.major.y = element_blank())
```

```{r session-info}
options(width = 80)
writeLines(capture.output(sessioninfo::session_info()), 'session.log')
```
